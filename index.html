<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>每日壁纸</title>
  <style>
    body { background:#111; color:#eee; font-family:sans-serif; margin:0; padding:0 }
    .header { padding:15px; text-align:center }
    .header h1 { margin:0; font-size:22px }
    .wallpaper-container {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
      gap:10px;
      padding:10px
    }
    .wallpaper-card { position:relative; cursor:pointer }
    .wallpaper-card img { width:100%; display:block; border-radius:8px }
    #loadMoreBtn {
      display:block;
      margin:20px auto;
      padding:10px 20px;
      border:none;
      border-radius:20px;
      background:#4a90e2;
      color:#fff;
      font-weight:bold;
      cursor:pointer
    }
    #sourceSelector { margin-top:10px; padding:5px }
  </style>
</head>
<body>
  <div class="header">
    <h1>每日壁纸</h1>
    <select id="sourceSelector">
      <option value="official">Bing（最近8天）</option>
      <option value="thirdparty">超清壁纸</option>
    </select>
  </div>
  <div class="wallpaper-container" id="wallpaperContainer"></div>
  <button id="loadMoreBtn" style="display:none">加载更多壁纸</button>

  <script>
    const wallpaperContainer = document.getElementById('wallpaperContainer');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const sourceSelector = document.getElementById('sourceSelector');

    const OFFICIAL_API = {
      type: "official",
      baseUrl: "https://cn.bing.com",
      apiPath: "/HPImageArchive.aspx",
      params: { format: "js", idx: 0, n: 8, mkt: "zh-CN" },
      imageBaseUrl: "https://cn.bing.com",
      useProxy: true,
      proxyUrl: "https://api.allorigins.win/raw?url="
    };

    const THIRD_PARTY_API = { type: "thirdparty" };
    const CORS_PROXY = "https://api.allorigins.win/raw?url=";

    let currentApi = OFFICIAL_API;
    let currentIndex = 0;

    sourceSelector.addEventListener('change', () => {
      currentApi = sourceSelector.value === 'official' ? OFFICIAL_API : THIRD_PARTY_API;
      resetAndLoadWallpapers();
    });

    loadMoreBtn.addEventListener('click', loadWallpapers);
    document.addEventListener('DOMContentLoaded', resetAndLoadWallpapers);

    function resetAndLoadWallpapers() {
      currentIndex = 0;
      wallpaperContainer.innerHTML = '';
      loadMoreBtn.style.display = currentApi.type === 'thirdparty' ? 'block' : 'none';
      loadWallpapers();
    }

    async function loadWallpapers() {
      loadMoreBtn.disabled = true;
      try {
        if (currentApi.type === 'official') {
          const list = await fetchOfficialWallpapers();
          renderWallpapers(list);
          loadMoreBtn.style.display = 'none';
        } else {
          const list = await fetchThirdPartyWallpapers();
          renderWallpapers(list);
          loadMoreBtn.style.display = 'block';
        }
      } catch (e) {
        console.error(e);
      } finally {
        loadMoreBtn.disabled = false;
      }
    }

    // 官方源
    async function fetchOfficialWallpapers() {
      const params = new URLSearchParams({ ...OFFICIAL_API.params, idx: 0, n: 8 });
      let url = OFFICIAL_API.baseUrl + OFFICIAL_API.apiPath + '?' + params;
      if (OFFICIAL_API.useProxy) url = OFFICIAL_API.proxyUrl + encodeURIComponent(url);
      const res = await fetch(url);
      const data = await res.json();
      return data.images.map(img => {
        const base = img.urlbase;
        return {
          thumb: OFFICIAL_API.imageBaseUrl + img.url,
          full:  OFFICIAL_API.imageBaseUrl + base + "_UHD.jpg"
        };
      });
    }

    // 第三方超清——拉取 Blob 再生成 objectURL
    async function fetchThirdPartyWallpapers() {
      const count = 8, results = [];
      for (let i = 0; i < count; i++) {
        const param = currentIndex + i + 100;
        const apiUrl = `https://wp.upx8.com/api.php?random=${param}`;
        // 用 AllOrigins 代理 GET 请求，规避 CORS
        const proxied = CORS_PROXY + encodeURIComponent(apiUrl);
        const res = await fetch(proxied);
        const blob = await res.blob();
        const objUrl = URL.createObjectURL(blob);

        results.push({ thumb: objUrl, full: objUrl });
      }
      currentIndex += count;
      return results;
    }

    function renderWallpapers(list) {
      list.forEach(wp => {
        const card = document.createElement('div');
        card.className = 'wallpaper-card';
        card.innerHTML = `<img src="${wp.thumb}" loading="lazy">`;
        card.onclick = () => window.open(wp.full, '_blank');
        wallpaperContainer.appendChild(card);
      });
    }

    // 自动滚动加载更多
    window.addEventListener('scroll', () => {
      if (
        currentApi.type === 'thirdparty' &&
        window.innerHeight + window.scrollY >= document.body.offsetHeight - 100 &&
        !loadMoreBtn.disabled
      ) loadWallpapers();
    });
  </script>
</body>
</html>